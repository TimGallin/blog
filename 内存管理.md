##内存分布##
多任务的操作系统中物理存储是所有任务所共有的，无论是内存还是硬盘，都是所有任务包括OS本身所需要分配的物理存储器。每一个任务都有自己的
虚拟内存空间。OS通过虚拟内存到物理内存的合理映射避免多任务之间的冲突。

在Windows中，系统的最小调度单位是线程（Thread），进程只是线程容器，其本身是不做任何实际操作的，任何一个进程中必须至少有一个线程的存在。而在Linux中，这个调度单位是进程（Process），准确的说，Linux中对于线程与进程的实现方式是一样的，线程只是与进程共享了某部分内存的进程。

##虚拟内存##
操作系统通过虚拟内存和物理存储器的映射来管理各个任务之间的独立运行。
在X86机器为例。程序的虚拟内存空间大小为4GB，并将该空间分割为内核空间与用户空间两大部分，在windows中默认这两部均为2GB大小，但可以通过在boot.ini文件中添加/3GB参数将用户空间增大至3GB。而在Linux中则默认用户空间为3GB。
内核空间部分用于载入系统资源（kernel32.dll），而用户空间则用于程序的ELF资源载入，堆、栈、全局、静态、常量的保存。值得一提是，内核模式的资源是所有进程所共享的,用户空间内无法访问到内核空间的内容。
![](https://i.imgur.com/71n2bKn.png)


内核空间通常有1GB的空间大小，但这并不是说系统就使用了1GB大小的内存！实际上他只使用一部分来映射他需要使用到的资源。
- **Stack**：位于用户空间的高地址空间，他的增加由高地址向低地址扩展，通常Stack的大小为8MB,这个值可以通常制定编译器的一些参数来进行更改，一旦程序所使用的stack变量超过制定的大小，就会出现stack overflow的错误。
内存映射段用于程序进行内存映射（File mapping）操作，例如创建内存映射文件或加载动态链接库。
- **BSS(Block Started by Symbol)：**BSS通常保存程序中尚未分配具体指未初始化的静态变量。
- **Data Segment：**数据段通常保存了程序中已经初始化好的静态变量（包含全局变量）。
- **Code Segment：**一般保存了可执行的指令，在程序运行时，系统将可执行文件由物理存储器映射到这里，通常这里的内容是只读的且在堆与栈的空间地址下方，这可以有效避免由于堆栈溢出而带来的对可执行文件的错误写入。

###虚拟地址到物理存储的映射#
>无论虚拟内存如何排布，最终的读写还是发生在物理存储器中。当程序需要对物理存储器进行访问时，操作系统需要一种机制以将虚拟内存映射到物理内存中。

在Linux中，系统通过<a href="http://lxr.linux.no/linux+v2.6.28.1/include/linux/sched.h#L1075" target="_blank" rel="noopener">task_struct</a>描述一个进程。这是一个庞大的结构体，其中变量mm指向一个内存管理描述符<a href="http://lxr.linux.no/linux+v2.6.28.1/include/linux/mm_types.h#L173" target="_blank" rel="noopener">mm_struct</a>,该描述符描述了进程对于虚拟内存的使用情况以及分布情况。而在该结构体中，还有<a href="http://lxr.linux.no/linux+v2.6.28.1/include/linux/mm_types.h#L99" target="_blank" rel="noopener">vm_area_struct</a>的变量以及指向下一个vm_area_struct变量的指针。这是一个对于各个内存段描述的List集合，该集合以虚拟地址顺序排列。vm_area_struct详细描述了在内存分布中的每一个分区的地址区域、访问权限、映射的文件等信息。
4GB的虚拟地址被在内部以页为单位被分割。无论是Linux还是Windows都以4KB为单位大小对用户空间进行分割。系统在分配物理存储器是同样也会以页面为单位进行分配。
同时在该结构体中包含一个指向<a href="http://lxr.linux.no/linux+v2.6.28.1/include/linux/mm_types.h#L185" target="_blank" rel="noopener">pgd_t</a>的的指针。该pgd是一个进程的页面表集合，他负责记录虚拟页面到物理页面的映射关系。
当程序需要访问某一个虚拟地址所映射的物理内容时，系统将首先通过查询mm_struct中的vm_area_struct，vm_area_struct除了保存以链表形式保存在mmap字段中，同时还以红黑树（rb_root）保存在mm_rb字段中，系统可以很快的通过查询得到虚拟地址的页信息，在通过pgd查询得到实际的物理存储器地址。